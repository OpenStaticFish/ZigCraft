name: Build

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Suppress git hints in checkout
  GIT_CONFIG_COUNT: 1
  GIT_CONFIG_KEY_0: init.defaultBranch
  GIT_CONFIG_VALUE_0: main

jobs:
  build:
    permissions:
      contents: read
      id-token: write
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v16

    - name: Cache Nix Store
      uses: nix-community/cache-nix-action@v7
      with:
        primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.nix', 'flake.lock') }}
        restore-prefixes-first-match: nix-${{ runner.os }}-
        paths: ~/.cache/nix

    - name: Build
      run: nix build -L

    - name: Prepare Artifact
      run: |
        mkdir -p dist
        cp -L result/bin/zigcraft dist/zigcraft-linux
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: zigcraft
        path: dist/
        retention-days: 7

  unit-test:
    permissions:
      contents: read
      id-token: write
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v16

    - name: Cache Nix Store
      uses: nix-community/cache-nix-action@v7
      with:
        primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.nix', 'flake.lock') }}
        restore-prefixes-first-match: nix-${{ runner.os }}-
        paths: ~/.cache/nix

    - name: Run unit tests
      run: nix develop --command zig build test
      env:
        ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global

  integration-test:
    permissions:
      contents: read
      id-token: write
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v16

    - name: Cache Nix Store
      uses: nix-community/cache-nix-action@v7
      with:
        primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.nix', 'flake.lock') }}
        restore-prefixes-first-match: nix-${{ runner.os }}-
        paths: ~/.cache/nix

    - name: Start headless Wayland compositor
      run: |
        mkdir -p /tmp/runtime-runner
        chmod 700 /tmp/runtime-runner
        export XDG_RUNTIME_DIR=/tmp/runtime-runner
        nix develop --command weston --socket=headless --backend=headless-backend.so --width=1280 --height=720 &
        echo "WAYLAND_DISPLAY=headless" >> $GITHUB_ENV
        echo "XDG_RUNTIME_DIR=/tmp/runtime-runner" >> $GITHUB_ENV
        sleep 5 # Wait for Weston to start up properly

    - name: Run integration smoke test
      env:
        ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global
      run: |
        nix develop --command zig build test-integration

    - name: Run world load smoke test (headless)
      env:
        ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global
        XDG_RUNTIME_DIR: /tmp/runtime-runner
        WAYLAND_DISPLAY: headless
        VK_ICD_FILENAMES: /run/opengl-driver/share/vulkan/icd.d/lvp_icd.x86_64.json
        # Skip presentation and use dry-run mode to avoid driver crashes in CI
        # Using build option -Dskip-present=true to guarantee it's baked in
        # 3 frames is enough to test multi-frame synchronization logic in dry-run
        ZIGCRAFT_SMOKE_FRAMES: "3"
        ZIGCRAFT_SAFE_MODE: "1"
      run: |
        # Find the actual path to the mesa driver and validation layers in the nix store
        LVP_PATH=$(nix build --no-link --print-out-paths nixpkgs#mesa.drivers)/share/vulkan/icd.d/lvp_icd.x86_64.json
        LAYER_PATH=$(nix build --no-link --print-out-paths nixpkgs#vulkan-validation-layers)/share/vulkan/explicit_layer.d
        export VK_ICD_FILENAMES=$LVP_PATH
        export VK_LAYER_PATH=$LAYER_PATH
        nix develop --command zig build run -Dsmoke-test=true -Dskip-present=true
