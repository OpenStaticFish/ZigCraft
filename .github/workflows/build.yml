name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Suppress git hints in checkout
  GIT_CONFIG_COUNT: 1
  GIT_CONFIG_KEY_0: init.defaultBranch
  GIT_CONFIG_VALUE_0: main

jobs:
  build:
    permissions:
      contents: read
      id-token: write
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v16

    - name: Cache Nix Store
      uses: nix-community/cache-nix-action@v7
      with:
        primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.nix', 'flake.lock') }}
        restore-prefixes-first-match: nix-${{ runner.os }}-
        paths: ~/.cache/nix

    - name: Build
      run: nix build -L

    - name: Prepare Artifact
      run: |
        mkdir -p dist
        cp -L result/bin/zigcraft dist/zigcraft-linux
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: zigcraft
        path: dist/
        retention-days: 7

  unit-test:
    permissions:
      contents: read
      id-token: write
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v16

    - name: Cache Nix Store
      uses: nix-community/cache-nix-action@v7
      with:
        primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.nix', 'flake.lock') }}
        restore-prefixes-first-match: nix-${{ runner.os }}-
        paths: ~/.cache/nix

    - name: Run unit tests
      run: nix develop --command zig build test
      env:
        ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global

  integration-test:
    permissions:
      contents: read
      id-token: write
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v16

    - name: Cache Nix Store
      uses: nix-community/cache-nix-action@v7
      with:
        primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.nix', 'flake.lock') }}
        restore-prefixes-first-match: nix-${{ runner.os }}-
        paths: ~/.cache/nix

    - name: Run integration smoke test
      env:
        XDG_RUNTIME_DIR: /tmp/runtime-runner
        ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-cache-global
      run: |
        mkdir -p $XDG_RUNTIME_DIR
        xvfb-run -a nix develop --command zig build test-integration
